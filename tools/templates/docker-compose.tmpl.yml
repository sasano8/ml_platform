{{- $cfg := ds "cfg" -}}  # $cfg でアクセスできるようにしておく。いちいち、(ds "cfg")しなくとも、$cfg でアクセス可能。

volumes:
  platform-k0s:
    name: platform-k0s


networks:
  # ip が変わると kubernetes が動かなくなるので 固定ipで管理
  default:
    name: fixed_compose_network
    external: true

services:
  kube:
    build:
      context: ./containers/k0s
    # container_name: kube-master
    hostname: kube-master  # host名が変わるとノードが NotReady となるため固定
    environment:
      EXTERNAL_DOMAIN: {{ (ds "cfg").merged.kube.external_domain | quote }}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      default:
        ipv4_address: {{ (ds "cfg").merged.kube.internal_ip | quote }}
#        aliases:
#          - {{ (ds "cfg").merged.kube.external_domain | quote }}
    privileged: true
    ports:
      - "30080:30080"  # for ingress
      - "30443:30443"  # for ingress
      - "6443:6443"
    restart: unless-stopped
    # taint: controller 専用とし、pod はデプロイできない
    command: ["k0s","controller","--enable-worker","--no-taints", "--single"]
    tmpfs:
      - /run
    volumes:
      - platform-k0s:/var/lib/k0s
      - /dev/kmsg:/dev/kmsg:ro  # カーネルログ
      # - /var/log/pods
      # - ./configs/kube:/mnt/kube
      # - ./volumes/step/certs:/certs:ro
      # - /run/containerd/containerd.sock:/run/containerd/containerd.sock

  kong:
    # networks:
    #   - default
    image: kong:3.6
    # depends_on:
    #   minio:
    #     condition: service_healthy
    environment:
      KONG_DATABASE: "off"                       # DB-less
      KONG_DECLARATIVE_CONFIG: /kong/kong.yaml
      KONG_PROXY_LISTEN: 0.0.0.0:8000 http2, 0.0.0.0:8443 ssl http2
      KONG_ADMIN_LISTEN: 0.0.0.0:8001 http2, 0.0.0.0:8444 ssl http2
      KONG_NGINX_PROXY_PROXY_MAX_TEMP_FILE_SIZE: "0"  # NGINX全体でしか適用できない 大きめアップロード向け
      KONG_LOG_LEVEL: notice
      KONG_SSL_CERT: {{ (ds "cfg").merged.kong.KONG_SSL_CERT | quote }}
      KONG_SSL_CERT_KEY: {{ (ds "cfg").merged.kong.KONG_SSL_CERT_KEY | quote }}
    volumes:
      - ./storage/cache/kong/kong.yaml:/kong/kong.yaml:ro
      - ./volumes/step/certs:/certs:ro
    ports:
      # - "80:8000"   # Proxy (HTTP)
      # - "443:8443"   # Proxy (HTTPS)
      - "8001:8001"   # Admin API (HTTP)
      - "8444:8444"   # Admin API (HTTPS)
      - "${KONG_HTTP_PORT}:8000"  # Proxy (HTTP)
      - "${KONG_HTTPS_PORT}:8443"  # Proxy (HTTPS)
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 5s
      timeout: 3s
      retries: 10

  stepca:
    image: smallstep/step-ca:latest
    user: {{ printf "%v:%v" (ds "cfg").merged.os.uid (ds "cfg").merged.os.gid | quote }}
    environment:
      DOCKER_STEPCA_INIT: 0
    volumes:
      - ./volumes/step:/home/step
    ports:
      - "9000:9000"
    # expose:
    #   - "9000"

  minio:
    # networks:
    #   - default
    image: minio/minio:latest
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      # バケットの Virtual-Host スタイルを有効化
      MINIO_DOMAIN: {{ (ds "cfg").merged.minio.MINIO_DOMAIN | quote }}
      # Kong 経由で外部URLを組み立てるための宣言
      MINIO_SERVER_URL: http://minio:9000
      MINIO_BROWSER_REDIRECT_URL: {{ (ds "cfg").merged.minio.MINIO_BROWSER_REDIRECT_URL | quote }}
    # ports:
    #   - "9000:9000"  # S3 API
    #   - "9001:9001"  # MinIO Console
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:9000/minio/health/ready"]
      interval: 10s
      timeout: 5s
      retries: 10

  # pocket-id:
  #   # networks:
  #   #   - default
  #   image: ghcr.io/pocket-id/pocket-id:v1
  #   ports:
  #     - 1411:1411
  #   # volumes:
  #   #   - "./data:/app/data"
  #   # env_file: .env
  #   environment:
  #     TRUST_PROXY: true  # kong を信用する
  #     MAXMIND_LICENSE_KEY:
  #     PUID: 1000
  #     PGID: 1000
  #   healthcheck:
  #     test: [ "CMD", "/app/pocket-id", "healthcheck" ]
  #     interval: 1m30s
  #     timeout: 5s
  #     retries: 2
  #     start_period: 10s

  zitadel:
    restart: unless-stopped
    image: ghcr.io/zitadel/zitadel:latest
    command: start-from-init --masterkey "MasterkeyNeedsToHave32Characters"
    environment:
      # See "What's next" to learn about how to serve Zitadel on a different domain or IP.
      ZITADEL_EXTERNALDOMAIN: {{ (ds "cfg").merged.kong.domains.zitadel_base | quote }}
      ZITADEL_EXTERNALPORT: 443

      # See "What's next" to learn about how to enable TLS.
      ZITADEL_EXTERNALSECURE: true
      # ZITADEL_EXTERNALSECURE: false
      ZITADEL_TLS_ENABLED: false  # TLS は Kong が担当

      # Database connection settings.
      ZITADEL_DATABASE_POSTGRES_HOST: db
      ZITADEL_DATABASE_POSTGRES_PORT: 5432
      # The database is created by the init job if it does not exist.
      ZITADEL_DATABASE_POSTGRES_DATABASE: zitadel
      # The admin user must already exist in the database.
      ZITADEL_DATABASE_POSTGRES_ADMIN_USERNAME: postgres
      ZITADEL_DATABASE_POSTGRES_ADMIN_PASSWORD: postgres
      ZITADEL_DATABASE_POSTGRES_ADMIN_SSL_MODE: disable
      # The zitadel user is created by the init job if it does not exist.
      ZITADEL_DATABASE_POSTGRES_USER_USERNAME: zitadel
      ZITADEL_DATABASE_POSTGRES_USER_PASSWORD: zitadel
      ZITADEL_DATABASE_POSTGRES_USER_SSL_MODE: disable

      # By configuring a login client, the setup job creates a user of type machine with the role IAM_LOGIN_CLIENT.
      # It writes a PAT to the path specified in ZITADEL_FIRSTINSTANCE_LOGINCLIENTPATPATH.
      # The PAT is passed to the login container via the environment variable ZITADEL_SERVICE_USER_TOKEN_FILE.
      ZITADEL_FIRSTINSTANCE_LOGINCLIENTPATPATH: /current-dir/login-client.pat
      ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORDCHANGEREQUIRED: false
      ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_MACHINE_USERNAME: login-client
      ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_MACHINE_NAME: Automatically Initialized IAM_LOGIN_CLIENT
      ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_PAT_EXPIRATIONDATE: '2029-01-01T00:00:00Z'
      # Activate the login v2 on an installation from scratch.
      # To activate the login v2 on an existing installation, read the "What's next" section.
      ZITADEL_DEFAULTINSTANCE_FEATURES_LOGINV2_REQUIRED: true # To use the login v1, set this to false.
      ZITADEL_DEFAULTINSTANCE_FEATURES_LOGINV2_BASEURI: https://{{ (ds "cfg").merged.kong.domains.zitadel_base }}/ui/v2/login
      # Configure the redirection paths to the login v2.
      # web.auth.172-31-97-7.sslip.io = zitadel:3000
      ZITADEL_OIDC_DEFAULTLOGINURLV2: https://{{ (ds "cfg").merged.kong.domains.zitadel_base }}/ui/v2/login/login?authRequest=
      ZITADEL_OIDC_DEFAULTLOGOUTURLV2: https://{{ (ds "cfg").merged.kong.domains.zitadel_base }}/ui/v2/login/logout?post_logout_redirect=
      ZITADEL_SAML_DEFAULTLOGINURLV2: https://{{ (ds "cfg").merged.kong.domains.zitadel_base }}/ui/v2/login/login?samlRequest=

      # By configuring a machine, the setup job creates a user of type machine with the role IAM_OWNER.
      # It writes a personal access token (PAT) to the path specified in ZITADEL_FIRSTINSTANCE_PATPATH.
      # The PAT can be used to provision resources with [Terraform](/docs/guides/manage/terraform-provider), for example.
      # ZITADEL_FIRSTINSTANCE_PATPATH: /current-dir/admin.pat
      # ZITADEL_FIRSTINSTANCE_ORG_MACHINE_MACHINE_USERNAME: admin
      # ZITADEL_FIRSTINSTANCE_ORG_MACHINE_MACHINE_NAME: Automatically Initialized IAM_OWNER
      # ZITADEL_FIRSTINSTANCE_ORG_MACHINE_PAT_EXPIRATIONDATE: '2029-01-01T00:00:00Z'

      # To change the initial human admin users username and password, uncomment the following lines.
      # The first login name is formatted like this: <username>@<org_name>.<external_domain>
      # With the following incommented configuration, this would be root@my-organization.localhost
      # Visit http://localhost:8080/ui/console to check if the login name works.
      # If you can't log in, check the available login names:
      # echo "select * from projections.login_names3;" | psql -h localhost -U postgres -d zitadel
      # The postgres users password is postgres.
      
      ZITADEL_FIRSTINSTANCE_ORG_NAME: My Organization  # root@my-organization.localhost
      # ZITADEL_FIRSTINSTANCE_ORG_NAME: my-org
      ZITADEL_FIRSTINSTANCE_ORG_HUMAN_USERNAME: root
      ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORD: RootPassword1!
      # root@my-organization.auth.172-31-97-7.sslip.io

      # Enable debug logs
      # ZITADEL_LOG_LEVEL: debug
      # Write Access Logs to stdout.
      # ZITADEL_LOGSTORE_ACCESS_STDOUT_ENABLED: true

    healthcheck:
      test:
        - CMD
        - /app/zitadel
        - ready
      interval: 10s
      timeout: 60s
      retries: 5
      start_period: 10s
    user: "0"
    volumes:
      - ./storage/cache/zitadel:/current-dir:delegated
    ports:
      - 8080:8080
      - 3000:3000
    networks:
      - default
    depends_on:
      db:
        condition: service_healthy

  # front-end
  zitadel-front:
    network_mode: service:zitadel  # zitadel コンテナのネットワークに同居させる
    # ports:
    #   - 3000:3000  # zitadel で指定した3000は、実際はこのコンテナで待ち受ける
    restart: unless-stopped
    image: ghcr.io/zitadel/zitadel-login:latest
    # If you can't use the network_mode service:zitadel, you can pass the environment variables ZITADEL_API_URL=http://zitadel:8080 and CUSTOM_REQUEST_HEADERS=Host:localhost instead.
    environment:
      - ZITADEL_API_URL=http://zitadel:8080
      - NEXT_PUBLIC_BASE_PATH=/ui/v2/login
      - ZITADEL_SERVICE_USER_TOKEN_FILE=/current-dir/login-client.pat
      - CUSTOM_REQUEST_HEADERS=Host:{{ (ds "cfg").merged.kong.domains.zitadel_base | quote }}  # Host ヘッダーをつけないと上手くいかない？
    user: "0"
    volumes:
      - ./storage/cache/zitadel:/current-dir:ro
    depends_on:
      zitadel:
        condition: service_healthy
        restart: false

  db:
    restart: unless-stopped
    image: postgres:17
    environment:
      PGUSER: postgres
      POSTGRES_PASSWORD: postgres
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready
      - -d
      - zitadel
      - -U
      - postgres
      interval: 10s
      timeout: 30s
      retries: 5
      start_period: 20s
    networks:
      - default
    ports:
      - 5432:5432
    volumes:
      - ./storage/persistent/postgres:/var/lib/postgresql/data:rw'
