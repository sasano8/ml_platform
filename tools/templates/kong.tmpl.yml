_format_version: "3.0"
_transform: true

# upstreams:
#   - name: ca.platform.localtest.me
#     targets:
#       - target: step-ca:9000   # 実体（コンテナ名:ポート）

services:
  # アンカーはトップレベルに定義できないので、ダミーのサービスで共通設定を管理する
  - name: _templates
    host: 127.0.0.1
    port: 1
    protocol: http
    tags: [template, do-not-use]

    # routes:
      # large_file を適用するサービス時はバッファを無効化して転送を高速化しておく
      # request_buffering: false
      # response_buffering: false

    plugins:
      - &disable_service
        name: request-termination
        enabled: false  # サービスを無効化
        protocols: ["https"]
        config:
          status_code: 403
          message: "Scheduled maintenance in progress"
      - &large_file
        name: request-size-limiting
        protocols: ["https"]
        config: # 共通値はトップレベルに定義できないので、共有する場合はここをベースにする
          allowed_payload_size: 0   # 0=制限なし（もしくは 10240=10MB 等）
          size_unit: megabytes

  # step-ca は content-length を返さない
  # kong は HTTP/1.1 の場合、それを transfer-encoding: chunked とみなす
  - name: ca-api
    host: stepca
    # protocol: https
    protocol: http
    tls_verify: null
    routes:
      - name: ca-route
        protocols: [ "https", "http"]
        # hosts: [ "ca.platform.localtest.me" ]
        hosts: [ {{ (ds "cfg").merged.kong.domains.stepca | quote }} ]
        preserve_host: true
        strip_path: false
        https_redirect_status_code: 308

  # - name: auth-api
  #   host: pocket-id
  #   port: 1411
  #   protocol: http
  #   routes:
  #     - name: auth-route
  #       protocols: ["https"]
  #       preserve_host: true
  #       strip_path: false

  # Minio Console（UI）
  - name: minio-console
    host: minio
    port: 9001
    protocol: http
    routes:
      - name: console-route
        protocols: ["https"]
        hosts: [ {{ (ds "cfg").merged.kong.domains.minio_console | quote }} ]
        preserve_host: true
        strip_path: false

  # Minio API
  - name: minio-s3
    host: minio
    port: 9000
    protocol: http
    routes:
      - name: s3-api
        protocols: ["https"]
        hosts: [ {{ (ds "cfg").merged.kong.domains.minio | quote }} ]
        preserve_host: true          # Host を書き換えない（SigV4/virtual-hostに必須）
        strip_path: false
        methods: [ "GET", "PUT", "POST", "DELETE", "HEAD", "OPTIONS" ]
        request_buffering: false  # バッファを無効化して送受信を高速化
        response_buffering: false  # バッファを無効化して送受信を高速化
        plugins:
          - name: cors
            config:
              origins: ["*"]
              methods: ["GET","PUT","POST","DELETE","HEAD"]
              headers: ["*"]
              credentials: false
              max_age: 3600
          - <<: *large_file

  - name: k8s-ingress-https
    routes:
      - name: route-k8s-https
        protocols: [ "https", "http" ]
        hosts:
          - {{ (ds "cfg").merged.kong.domains.knative_https | quote }}
        preserve_host: true
        strip_path: false

    host: kube-master
    port: 30080
    protocol: http  # 上流はTLSにしない
    tls_verify: null

  - name: k8s-ingress-grpcs
    routes:
      - name: route-k8s-grpcs
        protocols: [ "grpcs", "grpc" ]
        hosts:
          - {{ (ds "cfg").merged.kong.domains.knative_https | quote }}
        preserve_host: true
        strip_path: false
        headers:
          content-type:
            - ~*^application/grpc  # content-type で http と区別 

    host: kube-master
    port: 30080
    protocol: grpc  # 上流はTLSにしない
    tls_verify: null

  - name: auth-login
    host: zitadel-front
    port: 3000
    protocol: http
    routes:
      - name: auth-route-login
        protocols: ["https"]
        # snis: [ {{ (ds "cfg").merged.kong.domains.zitadel_base | quote }}, {{ (ds "cfg").merged.kong.domains.zitadel_web | quote }} ]
        snis: [ {{ (ds "cfg").merged.kong.domains.zitadel_base | quote }} ]
        # hosts: [ {{ (ds "cfg").merged.kong.domains.zitadel_base | quote }} ]
        paths:
          - /ui/v2/login
        methods: [ "GET", "PUT", "POST", "DELETE", "HEAD", "OPTIONS" ]
        # paths:
        #   - /
        preserve_host: true
        strip_path: false

  - name: auth-http
    host: zitadel
    port: 8080
    protocol: http
    routes:
      - name: auth-route-http
        protocols: ["https"]
        snis: [ {{ (ds "cfg").merged.kong.domains.zitadel_base | quote }} ]
        # hosts: [ {{ (ds "cfg").merged.kong.domains.zitadel_base | quote }} ]
        methods: [ "GET", "PUT", "POST", "DELETE", "HEAD", "OPTIONS" ]
        paths:
          - /
        preserve_host: true
        strip_path: false

  - name: auth-grpc
    host: zitadel
    port: 8080
    protocol: grpc
    routes:
      - name: auth-route-api
        protocols: ["grpcs"]
        snis: [ {{ (ds "cfg").merged.kong.domains.zitadel_base | quote }} ]
        # service: { host: zitadel, port: 8080, protocol: grpc }
        preserve_host: true
        strip_path: false

# kongは services か routes どちらかをトップレベルで定義することができるらしい
# routes:
  # - name: zitadel-http
  #   snis: [ {{ (ds "cfg").merged.kong.domains.zitadel_base | quote }} ]
  #   paths:
  #     - /
  #   preserve_host: true
  #   strip_path: false
  #   service: { host: zitadel, port: 3000, protocol: http }

  # - name: zitadel-route-login
  #   snis: [ {{ (ds "cfg").merged.kong.domains.zitadel_base | quote }}]
  #   methods: [ "GET", "PUT", "POST", "DELETE", "HEAD", "OPTIONS" ]
  #   paths:
  #     - /
  #     # - /ui/v2/login
  #   preserve_host: true
  #   strip_path: false
  #   service: { name: zitadel-svc-login, host: zitadel, port: 8080, protocol: http }

#   - name: zitadel-grpc
#     snis: [ {{ (ds "cfg").merged.kong.domains.zitadel_grpc | quote }} ]
#     preserve_host: true
#     strip_path: false
#     service: { host: zitadel, port: 8080, protocol: grpc }
